cove$SARSevent == 0,
as.numeric(difftime(pmin(ymd(cove$END_FU), cens_dt, na.rm=TRUE), ref_dt, units="days")),
as.numeric(difftime(pmin(ymd(cove$END_FU), cens_dt, ymd(cove$ADT), na.rm=TRUE), ref_dt, units="days"))
)
#Calculate standardized risk score and minority indicators
cove$standardized_risk_score<-ifelse(is.na(cove$standardized_risk_score), 0, cove$standardized_risk_score)
cove$MinorityInd <- ifelse(cove$RACE=="WHITE" & cove$ETHNIC!="HISPANIC OR LATINO", 0, 1)
cove$aht<-as.numeric(difftime(strata_dt, dmy("23SEP2021"), units="days"))
cove$Xstart_early<-as.numeric(difftime(ymd(cove$TR03SDT), dmy("23SEP2021"), units="days"))
cove$Xend_early<-as.numeric(difftime(ymd(cove$TR03SDT), dmy("23SEP2021"), units="days"))+13
cove$Xstart_full<-as.numeric(difftime(ymd(cove$TR03SDT), dmy("23SEP2021"), units="days"))+13
cove$futime<-as.numeric(difftime(cove$END_FU, dmy("23SEP2021"), units="days"))
# Obtain time to Delta/Omicron infection
cove <- cove %>%
mutate(
Omicron_time = SARStte,
Delta_time = SARStte,
Omicron_status = ifelse(SARSevent==1 & LGROUP=="Omicron", 1, 0),
Delta_status = ifelse(SARSevent==1 & LGROUP=="Delta", 1, 0),
)
?tmerge
l0<-tmerge(data1=cove %>%
dplyr::select(SUBJID, STRATAR, SEX, MinorityInd, standardized_risk_score) %>%
distinct(),
data2=cove, id=SUBJID, tstop=futime)
#Create time-dependent covariates for immediate vaccination and vaccination + 13 days
l0<-tmerge(l0, cove, id=SUBJID, early_boost_1 = tdc(Xstart_early))
l0<-tmerge(l0, cove, id=SUBJID, early_boost_2 = tdc(Xend_early))
l0<-l0 %>%
mutate(late_boost = ifelse(early_boost_1==1 & early_boost_2==1, 1, 0)) %>%
dplyr::select(-c("early_boost_1", "early_boost_2"))
l0<-tmerge(data1=cove %>%
dplyr::select(SUBJID, STRATAR, SEX, MinorityInd, standardized_risk_score) %>%
distinct(),
data2=cove, id=SUBJID, tstop=futime)
# Create event for Omicron and Delta infections
l0<-tmerge(l0, cove, id=SUBJID, Omicron = event(Omicron_time, Omicron_status))
l0<-tmerge(l0, cove, id=SUBJID, Delta = event(Delta_time, Delta_status))
#Create time-dependent covariates for immediate vaccination and vaccination + 13 days
l0<-tmerge(l0, cove, id=SUBJID, early_boost_1 = tdc(Xstart_early))
l0<-tmerge(l0, cove, id=SUBJID, early_boost_2 = tdc(Xend_early))
# create variables for 'early boost' (within 13 days of vaccination) and 'late boost' (≥14 days of vaccination)
l0<-l0 %>%
mutate(early_boost = early_boost_1 - early_boost_2)
l0<-l0 %>%
mutate(late_boost = ifelse(early_boost_1==1 & early_boost_2==1, 1, 0)) %>%
dplyr::select(-c("early_boost_1", "early_boost_2"))
# Filter for observations before SARS-CoV-2 event
l<-l0 %>% filter(tstop <= SARStte)
l0<-left_join(l0, cove %>% dplyr::select(SUBJID, Xstart_early, Xstart_full, SARStte), by="SUBJID")
# Filter for observations before SARS-CoV-2 event
l<-l0 %>% filter(tstop <= SARStte)
l$vacc_time<-ifelse(is.na(l$Xstart_early), Inf, l$Xstart_early)
l$vacc_status <- pmax(l$early_boost, l$late_boost)
100-Inf
I(100-Inf >= 14)
fit_DELTA<-coxph(formula = Surv(time=tstart, time2=tstop, event=Delta) ~
early_boost +
late_boost +
tt(vacc_time) +
strata(STRATAR) +
strata(SEX) +
strata(MinorityInd) +
standardized_risk_score,
tt = function(vacc_time, t, ...){
# Only contributes if at least 14 days after vaccine
as.numeric(t-vacc_time >= 14) * pmax(14, t - vacc_time, na.rm=TRUE)
},
data=l)
coef(fit_DELTA)
1-exp(-1.8050068083)
event_time <- sort(unique(l %>% summarise(tau = pmax(0, tstop-vacc_time, na.rm=TRUE)) %>% .$tau))
event_time
event_time <- sort(unique(l %>% summarise(tau = pmax(0, tstop-vacc_time, na.rm=TRUE)) %>% .$tau))
n_early <- sum(event_time<14)
times_lin = cbind(
c(rep(1, n_early), rep(0, length(event_time)-n_early)),
c(rep(0, n_early), rep(1, length(event_time)-n_early)), event_time)
times_lin
res_delta_cox<-data.frame(times=times_lin[,3])
times_lin[,3]<-ifelse(times_lin[,3]<14, 0, times_lin[,3])
times_lin %>% head()
p<-length(coef(fit_DELTA))-1
p
res_delta_cox$est<-apply(times_lin, 1, function(x) (x) %*% coef(fit_DELTA)[1:p])
res_delta_cox$se <- c(sqrt(apply(times_lin, 1, function(x) (x) %*% vcov(fit_DELTA)[1:p,1:p] %*% x)))
res_delta_cox$type="Delta"
res_delta_cox
res_cox<-rbind(res_delta_cox)
fit_OMICRON<-coxph(formula = Surv(time=tstart, time2=tstop, event=Omicron) ~
early_boost +
late_boost +
tt(vacc_time) +
strata(STRATAR) +
strata(SEX) +
strata(MinorityInd) +
standardized_risk_score, tt = function(vacc_time, t, ...){
as.numeric(t-vacc_time >= 14) * pmax(14, t - vacc_time, na.rm=TRUE)
},
data=l)
times_lin = cbind(
c(rep(1, n_early), rep(0, length(event_time)-n_early)),
c(rep(0, n_early), rep(1, length(event_time)-n_early)), event_time)
res_omicron_cox<-data.frame(times=times_lin[,3])
times_lin[,3]<-ifelse(times_lin[,3]<14, 0, times_lin[,3])
p<-length(coef(fit_OMICRON))-1
res_omicron_cox$est<-apply(times_lin, 1, function(x) (x) %*% coef(fit_OMICRON)[1:p])
res_omicron_cox$se <- c(sqrt(apply(times_lin, 1, function(x) (x) %*% vcov(fit_OMICRON)[1:p,1:p] %*% x)))
res_omicron_cox$type="Omicron"
res_cox<-bind_rows(res_cox, res_omicron_cox)
res_cox
res_cox$VE = 1-exp(res_cox$est)
res_cox$VE_lci = 1-exp(res_cox$est + qnorm(0.975) * res_cox$se)
res_cox$VE_uci = 1-exp(res_cox$est - qnorm(0.975) * res_cox$se)
res_cox
ag<-biofire %>%
dplyr::select(SUBJID, MBTEST, MBSCAT, mbdt_positive)
MBTESTs = biofire$MBTEST %>% unique()
id <- oracle %>% filter(PARAMCD=="TTCVDC1") %>% .$SUBJID %>% unique()
grid = expand.grid("SUBJID"=id, "MBTEST"=MBTESTs, "MBSCAT"="Nasopharyngeal Swab", "mbdt_positive"="")
ag<-rbind(ag,grid)
ag<-distinct(ag)
ag <- left_join(
oracle %>% dplyr::select(SUBJID, START_A, END_A, START_OL, START_BOOST, END_FU, AP02SDT, AP02EDT, AP03SDT, AP03EDT, TR03SDT, EOSDT, EFFCODT, TRT01P, PPROTFL, FASFL, MITTFL, STRATAR, SEX, RACE, ETHNIC, TRTSEQA, PPPSFL,standardized_risk_score, ends_with("_FU")),
ag, by="SUBJID")
id<-unique(adttea %>% filter(PARAMCD=="TTCVD24" & PPPSFL=="Y" & ADT > dmy("23SEP2021")) %>% .$SUBJID)
rm(id)
analysis_id<-unique(cove$SUBJID)
length(analysis_id)
ag<-biofire %>%
dplyr::select(SUBJID, MBTEST, MBSCAT, mbdt_positive)
MBTESTs = biofire$MBTEST %>% unique()
id <- oracle %>% filter(PARAMCD=="TTCVDC1") %>% .$SUBJID %>% unique()
grid = expand.grid("SUBJID"=id, "MBTEST"=MBTESTs, "MBSCAT"="Nasopharyngeal Swab", "mbdt_positive"="")
ag<-rbind(ag,grid)
ag<-distinct(ag)
ag <- left_join(
oracle %>% dplyr::select(SUBJID, START_A, END_A, START_OL, START_BOOST, END_FU, AP02SDT, AP02EDT, AP03SDT, AP03EDT, TR03SDT, EOSDT, EFFCODT, TRT01P, PPROTFL, FASFL, MITTFL, STRATAR, SEX, RACE, ETHNIC, TRTSEQA, PPPSFL,standardized_risk_score, ends_with("_FU")),
ag, by="SUBJID")
boost_a <- ag %>%
filter(SUBJID %in% analysis_id) %>%
mutate(
`BOOST_nonsars` = case_when(
END_FU <= ref_dt ~ NA,
END_FU > ref_dt & is.na(dmy(mbdt_positive)) ~ 0,
END_FU > ref_dt & !is.na(dmy(mbdt_positive)) ~ as.numeric( dplyr::between(dmy(mbdt_positive), ref_dt, pmin(END_FU, cens_dt)))),
`tte_BOOST_nonsars` = case_when(
END_FU <= ref_dt ~ NA,
END_FU > ref_dt & is.na(dmy(mbdt_positive)) ~ as.numeric(difftime(pmin(END_FU, cens_dt), ref_dt, units="days")),
END_FU > ref_dt & !is.na(dmy(mbdt_positive)) & dmy(mbdt_positive) <= ref_dt ~ as.numeric(difftime(pmin(END_FU, cens_dt), ref_dt, units="days")),
END_FU > ref_dt & !is.na(dmy(mbdt_positive)) & dmy(mbdt_positive) > ref_dt ~ as.numeric(difftime(pmin(END_FU, dmy(mbdt_positive), cens_dt), ref_dt, units="days"))
)
)
# Filter for distinct entries
boost_a <- boost_a %>%
dplyr::select(SUBJID, SEX, RACE, ETHNIC, TRTSEQA, PPROTFL, PPPSFL, MITTFL, STRATAR, standardized_risk_score, TR03SDT, tte_BOOST_nonsars, BOOST_nonsars, END_FU) %>%
group_by(SUBJID) %>%
distinct() %>%
ungroup() %>%
mutate(entry=0,
URM_status = ifelse(RACE=="WHITE" & ETHNIC!="HISPANIC OR LATINO", 0, 1))
boost_a$Xstart_early<-as.numeric(difftime(dmy(boost_a$TR03SDT), dmy("23SEP2021"), units="days"))
boost_a$Xend_early<-as.numeric(difftime(dmy(boost_a$TR03SDT), dmy("23SEP2021"), units="days"))+13
boost_a$Xstart_full<-as.numeric(difftime(dmy(boost_a$TR03SDT), dmy("23SEP2021"), units="days"))+13
boost_a$futime<-as.numeric(difftime(boost_a$END_FU, dmy("23SEP2021"), units="days"))
NS_events<-boost_a %>% dplyr::select(SUBJID, tte_BOOST_nonsars, BOOST_nonsars)
vaxx_times <- boost_a %>%
dplyr::select(SUBJID,
Xstart_early,
Xend_early) %>%
distinct()
NS_events<-boost_a %>% dplyr::select(SUBJID, tte_BOOST_nonsars, BOOST_nonsars)
NS_events
# Join events and vaccination times
l<-left_join(NS_events %>% group_by(SUBJID) %>% mutate(futime = max(tte_BOOST_nonsars)),
vaxx_times %>% mutate(aht=ath_thresh), by="SUBJID") %>%
arrange(SUBJID, tte_BOOST_nonsars) %>%
group_by(SUBJID) %>%
mutate(event_num=row_number()) %>%
pivot_wider(names_from=event_num, values_from=c(tte_BOOST_nonsars, BOOST_nonsars))
ath_thresh
rm(l)
# Filter for observations before SARS-CoV-2 event
cove<-l0 %>% filter(tstop <= SARStte)
# Filter for observations before SARS-CoV-2 event
cove<-l0 %>% filter(tstop <= SARStte)
### Delta endpoint
cove$vacc_time<-ifelse(is.na(cove$Xstart_early), Inf, cove$Xstart_early)
cove$vacc_status <- pmax(cove$early_boost, cove$late_boost)
# Join events and vaccination times
l<-left_join(NS_events %>% group_by(SUBJID) %>% mutate(futime = max(tte_BOOST_nonsars)),
vaxx_times, #%>%
#mutate(aht=ath_thresh),
by="SUBJID") %>%
arrange(SUBJID, tte_BOOST_nonsars) %>%
group_by(SUBJID) %>%
mutate(event_num=row_number()) %>%
pivot_wider(names_from=event_num, values_from=c(tte_BOOST_nonsars, BOOST_nonsars))
l0<-tmerge(data1=boost_a %>% dplyr::select(SUBJID, STRATAR, SEX, URM_status, standardized_risk_score) %>% distinct(), data2=l, id=SUBJID, tstop=futime, aht=tdc(aht))
# Join events and vaccination times
l<-left_join(NS_events %>% group_by(SUBJID) %>% mutate(futime = max(tte_BOOST_nonsars)),
vaxx_times,
by="SUBJID") %>%
arrange(SUBJID, tte_BOOST_nonsars) %>%
group_by(SUBJID) %>%
mutate(event_num=row_number()) %>%
pivot_wider(names_from=event_num, values_from=c(tte_BOOST_nonsars, BOOST_nonsars))
l0<-tmerge(data1=boost_a %>% dplyr::select(SUBJID, STRATAR, SEX, URM_status, standardized_risk_score) %>% distinct(), data2=l, id=SUBJID, tstop=futime)
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_1, BOOST_nonsars_1))
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_2, BOOST_nonsars_2))
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_3, BOOST_nonsars_3))
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_4, BOOST_nonsars_4))
l0<-tmerge(l0, l, id=SUBJID, early_boost_1 = tdc(Xstart_early))
l0<-tmerge(l0, l, id=SUBJID, early_boost_2 = tdc(Xend_early))
l0<-l0 %>% mutate(early_boost = early_boost_1 - early_boost_2) #%>% dplyr::select(-c("early_boost_1", "early_boost_2"))
l0<-l0 %>% mutate(late_boost = ifelse(early_boost_1==1 & early_boost_2==1, 1, 0)) %>% dplyr::select(-c("early_boost_1", "early_boost_2"))
l0<-left_join(l0, vaxx_times, by="SUBJID")
l0
#replace unboosted with Infinite boost date
l0$standardized_risk_score<-ifelse(is.na(l0$standardized_risk_score), 0, l0$standardized_risk_score)
#l0$Xend_early<-ifelse(is.na(l0$Xend_early), Inf, l0$Xend_early)
l0$vacc_time<-ifelse(is.na(l0$Xstart_early), Inf, l0$Xstart_early)
nonsars_events <- l0 %>%
filter(infect ==1) %>%
mutate(tau = pmax(0, tstop - Xend_early, na.rm=TRUE), type="Non-SARS")
events <- rbind(
delta_events %>% dplyr::select(1:7, 11, 13, 16),
omicron_events %>% dplyr::select(1:7, 11, 13, 16),
nonsars_events %>% dplyr::select(1:7, 11, 13, 16) %>% rename(MinorityInd = URM_status, Xstart_full=Xend_early)
)
cove<-adttea_e
# collect analysis IDs: 20,404 participants
analysis_id<-unique(cove$SUBJID)
cove<-left_join(cove, oracle %>%
dplyr::select(SUBJID, standardized_risk_score, END_FU),
by="SUBJID")
#flag SARS-CoV-2 events
cove$SARSevent = as.numeric(cove$CNSR==0 & between(cove$ADT, ref_dt, pmin(cove$END_FU, cens_dt)))
#flag time to SARS-CoV-2 event
cove$SARStte = ifelse(
cove$SARSevent == 0,
as.numeric(difftime(pmin(ymd(cove$END_FU), cens_dt, na.rm=TRUE), ref_dt, units="days")),
as.numeric(difftime(pmin(ymd(cove$END_FU), cens_dt, ymd(cove$ADT), na.rm=TRUE), ref_dt, units="days"))
)
#Calculate standardized risk score and minority indicators
cove$standardized_risk_score<-ifelse(is.na(cove$standardized_risk_score), 0, cove$standardized_risk_score)
cove$MinorityInd <- ifelse(cove$RACE=="WHITE" & cove$ETHNIC!="HISPANIC OR LATINO", 0, 1)
cove$aht<-as.numeric(difftime(strata_dt, dmy("23SEP2021"), units="days"))
# Obtain boost date, boost date + 13 days, and follow-up time
cove$Xstart_early<-as.numeric(difftime(ymd(cove$TR03SDT), dmy("23SEP2021"), units="days"))
cove$Xend_early<-as.numeric(difftime(ymd(cove$TR03SDT), dmy("23SEP2021"), units="days"))+13
cove$Xstart_full<-as.numeric(difftime(ymd(cove$TR03SDT), dmy("23SEP2021"), units="days"))+13
cove$futime<-as.numeric(difftime(cove$END_FU, dmy("23SEP2021"), units="days"))
# Obtain time to Delta/Omicron infection
cove <- cove %>%
mutate(
Omicron_time = SARStte,
Delta_time = SARStte,
Omicron_status = ifelse(SARSevent==1 & LGROUP=="Omicron", 1, 0),
Delta_status = ifelse(SARSevent==1 & LGROUP=="Delta", 1, 0),
)
# Initialize `start`/`stop` data
l0<-tmerge(data1=cove %>%
dplyr::select(SUBJID, STRATAR, SEX, MinorityInd, standardized_risk_score) %>%
distinct(),
data2=cove, id=SUBJID, tstop=futime)
# Create event for Omicron and Delta infections
l0<-tmerge(l0, cove, id=SUBJID, Omicron = event(Omicron_time, Omicron_status))
l0<-tmerge(l0, cove, id=SUBJID, Delta = event(Delta_time, Delta_status))
#Create time-dependent covariates for immediate vaccination and vaccination + 13 days
l0<-tmerge(l0, cove, id=SUBJID, early_boost_1 = tdc(Xstart_early))
l0<-tmerge(l0, cove, id=SUBJID, early_boost_2 = tdc(Xend_early))
# create variables for 'early boost' (within 13 days of vaccination) and 'late boost' (≥14 days of vaccination)
l0<-l0 %>%
mutate(early_boost = early_boost_1 - early_boost_2)
l0<-l0 %>%
mutate(late_boost = ifelse(early_boost_1==1 & early_boost_2==1, 1, 0)) %>%
dplyr::select(-c("early_boost_1", "early_boost_2"))
l0<-left_join(l0, cove %>% dplyr::select(SUBJID, Xstart_early, Xstart_full, SARStte), by="SUBJID")
# Filter for observations before SARS-CoV-2 event
cove<-l0 %>% filter(tstop <= SARStte)
### Delta endpoint
cove$vacc_time<-ifelse(is.na(cove$Xstart_early), Inf, cove$Xstart_early)
cove$vacc_status <- pmax(cove$early_boost, cove$late_boost)
omicron_events <- l0 %>% filter(Omicron==1) %>% mutate(tau = pmax(0, SARStte - Xstart_full, na.rm=TRUE), type="Omicron")
delta_events <- l0 %>% filter(Delta==1) %>% mutate(tau = pmax(0, SARStte - Xstart_full, na.rm=TRUE), type="Delta")
ag<-biofire %>%
dplyr::select(SUBJID, MBTEST, MBSCAT, mbdt_positive)
MBTESTs = biofire$MBTEST %>% unique()
id <- oracle %>% filter(PARAMCD=="TTCVDC1") %>% .$SUBJID %>% unique()
grid = expand.grid("SUBJID"=id, "MBTEST"=MBTESTs, "MBSCAT"="Nasopharyngeal Swab", "mbdt_positive"="")
ag<-rbind(ag,grid)
ag<-distinct(ag)
#2) join Part A, B, C Start and End dates to PE data
ag <- left_join(
oracle %>% dplyr::select(SUBJID, START_A, END_A, START_OL, START_BOOST, END_FU, AP02SDT, AP02EDT, AP03SDT, AP03EDT, TR03SDT, EOSDT, EFFCODT, TRT01P, PPROTFL, FASFL, MITTFL, STRATAR, SEX, RACE, ETHNIC, TRTSEQA, PPPSFL,standardized_risk_score, ends_with("_FU")),
ag, by="SUBJID")
# Collect indicator and time-to-off-target events
boost_a <- ag %>%
filter(SUBJID %in% analysis_id) %>%
mutate(
`BOOST_nonsars` = case_when(
END_FU <= ref_dt ~ NA,
END_FU > ref_dt & is.na(dmy(mbdt_positive)) ~ 0,
END_FU > ref_dt & !is.na(dmy(mbdt_positive)) ~ as.numeric( dplyr::between(dmy(mbdt_positive), ref_dt, pmin(END_FU, cens_dt)))),
`tte_BOOST_nonsars` = case_when(
END_FU <= ref_dt ~ NA,
END_FU > ref_dt & is.na(dmy(mbdt_positive)) ~ as.numeric(difftime(pmin(END_FU, cens_dt), ref_dt, units="days")),
END_FU > ref_dt & !is.na(dmy(mbdt_positive)) & dmy(mbdt_positive) <= ref_dt ~ as.numeric(difftime(pmin(END_FU, cens_dt), ref_dt, units="days")),
END_FU > ref_dt & !is.na(dmy(mbdt_positive)) & dmy(mbdt_positive) > ref_dt ~ as.numeric(difftime(pmin(END_FU, dmy(mbdt_positive), cens_dt), ref_dt, units="days"))
)
)
# Filter for distinct entries
boost_a <- boost_a %>%
dplyr::select(SUBJID, SEX, RACE, ETHNIC, TRTSEQA, PPROTFL, PPPSFL, MITTFL, STRATAR, standardized_risk_score, TR03SDT, tte_BOOST_nonsars, BOOST_nonsars, END_FU) %>%
group_by(SUBJID) %>%
distinct() %>%
ungroup() %>%
mutate(entry=0,
URM_status = ifelse(RACE=="WHITE" & ETHNIC!="HISPANIC OR LATINO", 0, 1))
# Flag early boost date, late boost date, and FUtime, and at home testing date
boost_a$Xstart_early<-as.numeric(difftime(dmy(boost_a$TR03SDT), dmy("23SEP2021"), units="days"))
boost_a$Xend_early<-as.numeric(difftime(dmy(boost_a$TR03SDT), dmy("23SEP2021"), units="days"))+13
boost_a$Xstart_full<-as.numeric(difftime(dmy(boost_a$TR03SDT), dmy("23SEP2021"), units="days"))+13
boost_a$futime<-as.numeric(difftime(boost_a$END_FU, dmy("23SEP2021"), units="days"))
ath_thresh <- as.numeric(difftime(dmy("15JAN2022"), ref_dt, units="days"))
# Create dataset of non-sars-cov-2 (off-target) event indicators and event times (multiple records per PPT)
NS_events<-boost_a %>% dplyr::select(SUBJID, tte_BOOST_nonsars, BOOST_nonsars)
# Obtain vaccination times for each ppt
vaxx_times <- boost_a %>%
dplyr::select(SUBJID,
Xstart_early,
Xend_early) %>%
distinct()
# Join events and vaccination times
l<-left_join(NS_events %>% group_by(SUBJID) %>% mutate(futime = max(tte_BOOST_nonsars)),
vaxx_times,
by="SUBJID") %>%
arrange(SUBJID, tte_BOOST_nonsars) %>%
group_by(SUBJID) %>%
mutate(event_num=row_number()) %>%
pivot_wider(names_from=event_num, values_from=c(tte_BOOST_nonsars, BOOST_nonsars))
l0<-tmerge(data1=boost_a %>% dplyr::select(SUBJID, STRATAR, SEX, URM_status, standardized_risk_score) %>% distinct(), data2=l, id=SUBJID, tstop=futime)
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_1, BOOST_nonsars_1))
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_2, BOOST_nonsars_2))
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_3, BOOST_nonsars_3))
l0<-tmerge(l0, l, id=SUBJID, infect = event(tte_BOOST_nonsars_4, BOOST_nonsars_4))
l0<-tmerge(l0, l, id=SUBJID, early_boost_1 = tdc(Xstart_early))
l0<-tmerge(l0, l, id=SUBJID, early_boost_2 = tdc(Xend_early))
l0<-l0 %>% mutate(early_boost = early_boost_1 - early_boost_2) #%>% dplyr::select(-c("early_boost_1", "early_boost_2"))
l0<-l0 %>% mutate(late_boost = ifelse(early_boost_1==1 & early_boost_2==1, 1, 0)) %>% dplyr::select(-c("early_boost_1", "early_boost_2"))
l0<-left_join(l0, vaxx_times, by="SUBJID")
#replace unboosted with Infinite boost date
l0$standardized_risk_score<-ifelse(is.na(l0$standardized_risk_score), 0, l0$standardized_risk_score)
#l0$Xend_early<-ifelse(is.na(l0$Xend_early), Inf, l0$Xend_early)
l0$vacc_time<-ifelse(is.na(l0$Xstart_early), Inf, l0$Xstart_early)
nonsars_events <- l0 %>%
filter(infect ==1) %>%
mutate(tau = pmax(0, tstop - Xend_early, na.rm=TRUE), type="Non-SARS")
events <- rbind(
delta_events %>% dplyr::select(1:7, 11, 13, 16),
omicron_events %>% dplyr::select(1:7, 11, 13, 16),
nonsars_events %>% dplyr::select(1:7, 11, 13, 16) %>% rename(MinorityInd = URM_status, Xstart_full=Xend_early)
)
delta_events %>% dplyr::select(1:7, 11, 13, 16)
head(delta_events)
delta_events %>% dplyr::select(1:7, 10, 11, 13, 16)
delta_events %>% dplyr::select(1:7, 10, 11, 13, 16) %>% head()
nonsars_events %>% dplyr::select(1:7, 11, 13, 16)
nonsars_events %>% head()
nonsars_events %>% n col()
nonsars_events %>% ncol()
nonsars_events %>% dplyr::select(1:7, 9, 10, 12, 15) %>% rename(MinorityInd = URM_status, Xstart_full=Xend_early)
events <- rbind(
delta_events %>% dplyr::select(1:7, 10, 11, 13, 16),
omicron_events %>% dplyr::select(1:7, 10, 11, 13, 16),
nonsars_events %>% dplyr::select(1:7, 9, 10, 12, 15) %>% rename(MinorityInd = URM_status, Xstart_full=Xend_early)
)
events
events <- events %>%
group_by(SUBJID) %>%
slice(which.min(tstop)) %>%
ungroup()
events
events %>% as.data.frame()
events %>% as.data.frame() %>% head()
max_t_delta <- events %>% filter(type=="Delta") %>% .$tstop %>% max()
scale_f=365.25
max_t_delta
delta_eligible <- events %>% filter(tstop <= max_t_delta)
delta_eligible %>% head()
delta_eligible %>% dim()
delta_eligible <- events %>%
filter(tstop <= max_t_delta & type != "Omicron") %>%
dplyr::select(Xstart_full, tstop, type) %>%
mutate(tstop = tstop/scale_f * max_t_delta,
Xstart_full = Xstart_full/scale_f * max_t_delta,
type = ifelse(type=="Delta", 1, 0)) %>%
rename(
`T`=tstop,
`V`=Xstart_full,
`J`= type
)
delta_eligible
max_t_delta
delta_eligible <- events %>%
filter(tstop <= max_t_delta & type != "Omicron") %>%
dplyr::select(Xstart_full, tstop, type) %>%
mutate(tstop = tstop/scale_f,
Xstart_full = Xstart_full/scale_f,
type = ifelse(type=="Delta", 1, 0)) %>%
rename(
`T`=tstop,
`V`=Xstart_full,
`J`= type
)
sieve_est_delta <- sieve_partially_linear_logistic(dat=delta_eligible, psi_delta = psi_d2, monotone = TRUE)
sieve_est_delta$beta
delta_eligible <- events %>%
filter(tstop <= max_t_delta & type != "Omicron") %>%
dplyr::select(Xstart_full, tstop, type) %>%
mutate(tstop = tstop,
Xstart_full = Xstart_full,
type = ifelse(type=="Delta", 1, 0)) %>%
rename(
`T`=tstop,
`V`=Xstart_full,
`J`= type
)
sieve_est_delta <- sieve_partially_linear_logistic(dat=delta_eligible, psi_delta = psi_d2, monotone = TRUE)
sieve_est_delta$beta
delta_eligible <- events %>%
filter(tstop <= max_t_delta & type != "Omicron") %>%
dplyr::select(Xstart_full, tstop, type) %>%
mutate(tstop = tstop/scale_f,
Xstart_full = Xstart_full/scale_f,
type = ifelse(type=="Delta", 1, 0)) %>%
rename(
`T`=tstop,
`V`=Xstart_full,
`J`= type
)
sieve_est_delta <- sieve_partially_linear_logistic(dat=delta_eligible, psi_delta = psi_d2, monotone = TRUE)
tmle_est_delta <- tmle_iterative(dat=delta_eligible, psi_delta=psi_d2, monotone=TRUE)
delta_eligible
delta_eligible <- events %>%
filter(tstop <= max_t_delta & type != "Omicron") %>%
dplyr::select(Xstart_full, tstop, type) %>%
mutate(tstop = tstop/scale_f,
Xstart_full = Xstart_full/scale_f,
type = ifelse(type=="Delta", 1, 0)) %>%
rename(
`T`=tstop,
`V`=Xstart_full,
`J`= type
)
sieve_est_delta <- sieve_partially_linear_logistic(dat=delta_eligible, psi_delta = psi_d2, monotone = TRUE)
tmle_est_delta <- tmle_iterative(dat=delta_eligible, psi_delta=psi_d2, monotone=TRUE)
delta_eligible
table(delta_eligible$J)
#dat=dat_wane_run
dat=delta_eligible
J.name = "J"; T.name = "T"; V.name="V";smooth_r=TRUE;smooth_alpha=TRUE;monotone=TRUE
psi_delta=psi_d2
verbose=TRUE
tol=1e-6
maxit=500
n <- nrow(dat)
J <- as.numeric(dat[[J.name]])
Tvec <- dat[[T.name]]
Vvec <- dat[[V.name]]
Z<-psi_delta(Tvec, Vvec, ...)
Z<-psi_d2(Tvec, Vvec)
Z
delta_eligible <- events %>%
filter(tstop <= max_t_delta & type != "Omicron") %>%
dplyr::select(Xstart_full, tstop, type) %>%
mutate(tstop = tstop/scale_f,
Xstart_full = Xstart_full/scale_f,
type = ifelse(type=="Delta", 1, 0)) %>%
mutate(
Xstart_full = case_when(
is.na(Xstart_full) ~ Inf,
.default = Xstart_full
)
) %>%
rename(
`T`=tstop,
`V`=Xstart_full,
`J`= type
)
sieve_est_delta <- sieve_partially_linear_logistic(dat=delta_eligible, psi_delta = psi_d2, monotone = TRUE)
tmle_est_delta <- tmle_iterative(dat=delta_eligible, psi_delta=psi_d2, monotone=TRUE)
tmle_est_delta$beta
sieve_est_delta$beta
coef(fit_DELTA)
0.0002516788 * 365.25
max_t_delta
max_t_delta/365.25
cbind(1, seq(0, max_t_delta/365.25, by=0.001))
tmle_est_delta$beta %*% cbind(1, seq(0, max_t_delta/365.25, by=0.001))
tmle_est_delta$beta
cbind(1, seq(0, max_t_delta/365.25, by=0.001)) %*% tmle_est_delta$beta
cbind(1, seq(0, 90/365.25, by=0.001)) %*% tmle_est_delta$beta
tmp$t <- seq(0, 90/365.25, by=0.001) * 365.25
tmp <- data.frame(t=seq(0, 90/365.25, by=0.001) * 365.25)
tmp$VE <- 1-exp(cbind(1, seq(0, 90/365.25, by=0.001)) %*% tmle_est_delta$beta)
ggplot(aes(x=t, y=VE))+geom_line()+ylim(c(0, 1))
ggplot(aes(x=t, y=VE), data=tmp)+geom_line()+ylim(c(0, 1))
ggplot(aes(x=t, y=VE), data=tmp)+geom_line()+ylim(c(0, 1))
plot(tmp$t, tmp$VE, type="l", ylim=c(0,1))
ggplot(aes(x=t, y=VE), data=tmp)+geom_line()+ylim(c(0, 1))
